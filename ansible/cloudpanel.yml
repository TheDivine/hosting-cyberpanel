---
- name: Harden server and install CloudPanel
  hosts: cyberpanel
  become: true
  gather_facts: true

  pre_tasks:
    - name: Assert supported OS (Ubuntu 22.04)
      ansible.builtin.assert:
        that:
          - ansible_facts['os_family'] == 'Debian'
          - ansible_facts['distribution'] == 'Ubuntu'
          - ansible_facts['distribution_major_version'] | int >= 22
        fail_msg: "This playbook targets Ubuntu 22.04+."
        success_msg: "OS check passed."
      tags: [hardening]

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ cp_hostname }}"
      tags: [hardening]

    - name: Check if primary apt sources list exists
      ansible.builtin.stat:
        path: /etc/apt/sources.list
      register: apt_sources_list_stat
      tags: [hardening]

    - name: Check if provider sources backup exists
      ansible.builtin.stat:
        path: /etc/apt/sources.list.provider
      register: apt_sources_backup_stat
      tags: [hardening]

    - name: Backup provider sources list
      ansible.builtin.copy:
        src: /etc/apt/sources.list
        dest: /etc/apt/sources.list.provider
        owner: root
        group: root
        mode: '0644'
        remote_src: true
      when: apt_sources_list_stat.stat.exists and not apt_sources_backup_stat.stat.exists
      tags: [hardening]

    - name: Remove existing primary apt sources list
      ansible.builtin.file:
        path: /etc/apt/sources.list
        state: absent
      when: apt_sources_list_stat.stat.exists
      tags: [hardening]

    - name: Check if /etc/apt/sources.list.d exists
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d
      register: apt_sources_d_stat
      tags: [hardening]

    - name: Find apt source snippets (.list)
      ansible.builtin.find:
        paths: /etc/apt/sources.list.d
        patterns: '*.list'
        file_type: file
      register: apt_list_snippets
      when: apt_sources_d_stat.stat.exists
      tags: [hardening]

    - name: Find apt source snippets (.sources)
      ansible.builtin.find:
        paths: /etc/apt/sources.list.d
        patterns: '*.sources'
        file_type: file
      register: apt_sources_snippets
      when: apt_sources_d_stat.stat.exists
      tags: [hardening]

    - name: Remove provider apt source snippets
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ (apt_list_snippets.files | default([])) + (apt_sources_snippets.files | default([])) }}"
      when: (apt_list_snippets is defined) or (apt_sources_snippets is defined)
      tags: [hardening]

    - name: Ensure canonical apt sources list present
      ansible.builtin.copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }}-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }}-backports main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security main restricted universe multiverse
        owner: root
        group: root
        mode: '0644'
      tags: [hardening]

    - name: Find any apt config files that may reference nocix
      ansible.builtin.find:
        paths: /etc/apt
        recurse: true
        patterns: '*.list,*.sources,*.conf,*.cfg'
        file_type: file
      register: apt_any_configs
      failed_when: false
      tags: [hardening]

    - name: Replace nocix URIs with Canonical archive in apt config
      ansible.builtin.replace:
        path: "{{ item.path }}"
        regexp: 'http://repo\\.nocix\\.net/repo/ubuntu'
        replace: 'http://archive.ubuntu.com/ubuntu'
      loop: "{{ apt_any_configs.files | default([]) }}"
      loop_control:
        label: "{{ item.path }}"
      tags: [hardening]

    - name: "Disable nocix in Deb822 sources (set Enabled: no)"
      ansible.builtin.replace:
        path: "{{ item.path }}"
        regexp: '^(Enabled:\\s*)yes$'
        replace: '\\1no'
      loop: "{{ apt_any_configs.files | default([]) }}"
      when:
        - item.path is defined
        - item.path | regex_search('.*\\.sources$')
      loop_control:
        label: "{{ item.path }}"
      tags: [hardening]

    - name: Clean APT cache after source changes
      ansible.builtin.command: apt-get clean
      changed_when: false
      tags: [hardening]

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [hardening]

  vars:
    base_allowed_tcp_ports:
      - 80
      - 443
      - 8443    # CloudPanel UI

  tasks:
    - name: Create admin user
      ansible.builtin.user:
        name: "{{ admin_user }}"
        shell: /bin/bash
        groups: sudo
        append: true
        create_home: true
      tags: [hardening]

    - name: Add admin authorized key (if provided)
      ansible.posix.authorized_key:
        user: "{{ admin_user }}"
        key: "{{ admin_pubkey }}"
        manage_dir: true
      when: admin_pubkey is defined and admin_pubkey | length > 10
      tags: [hardening]

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - ufw
          - fail2ban
          - unattended-upgrades
          - ca-certificates
          - gnupg
          - software-properties-common
          - chrony
          - rsyslog
          - lsb-release
        state: present
      tags: [hardening]

    - name: Install ClamAV malware scanner
      ansible.builtin.apt:
        name:
          - clamav
          - clamav-daemon
        state: present
      when: enable_clamav
      tags: [malware]

    - name: Ensure ClamAV log directory exists
      ansible.builtin.file:
        path: /var/log/clamav
        state: directory
        owner: root
        group: clamav
        mode: '0750'
      when: enable_clamav
      tags: [malware]

    - name: Ensure FreshClam signature service is running
      ansible.builtin.service:
        name: clamav-freshclam
        state: started
        enabled: true
      when: enable_clamav
      tags: [malware]

    - name: Schedule daily ClamAV scan
      ansible.builtin.cron:
        name: Daily ClamAV scan
        user: root
        hour: "{{ clamav_scan_hour }}"
        minute: "{{ clamav_scan_minute }}"
        job: "/usr/bin/nice -n 15 /usr/bin/clamscan --recursive --infected --log=/var/log/clamav/daily-scan.log {{ malware_scan_paths | join(' ') }} || true"
      when: enable_clamav
      tags: [malware]

    - name: Install Linux Malware Detect
      ansible.builtin.shell: |
        set -euo pipefail
        tmpdir=$(mktemp -d)
        trap 'rm -rf "$tmpdir"' EXIT
        cd "$tmpdir"
        wget -q https://www.rfxn.com/downloads/maldetect-current.tar.gz
        set +o pipefail
        top_entry=$(tar -tzf maldetect-current.tar.gz | head -n1 | cut -d/ -f1 || true)
        set -o pipefail
        if [ -z "$top_entry" ]; then
          echo "Failed to determine maldetect directory from archive" >&2
          exit 1
        fi
        tar -xzf maldetect-current.tar.gz
        cd "$top_entry"
        ./install.sh >/dev/null
      args:
        creates: /usr/local/sbin/maldet
        executable: /bin/bash
      when: enable_maldet
      tags: [malware]

    - name: Enable ClamAV engine within Maldet
      ansible.builtin.lineinfile:
        path: /usr/local/maldetect/conf.maldet
        regexp: '^scan_clamscan='
        line: 'scan_clamscan="1"'
      when: enable_maldet and enable_clamav
      tags: [malware]

    - name: Schedule daily Maldet scan
      ansible.builtin.cron:
        name: Daily Maldet scan
        user: root
        hour: "{{ maldet_scan_hour }}"
        minute: "{{ maldet_scan_minute }}"
        job: "/usr/bin/nice -n 15 /usr/local/sbin/maldet -b -r {{ malware_scan_paths | join(' ') }} 2>&1 | /usr/bin/logger -t maldet"
      when: enable_maldet
      tags: [malware]

    - name: Configure unattended upgrades
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          Unattended-Upgrade::Origins-Pattern {
            "origin=Ubuntu,codename=${distro_codename}-security,label=Ubuntu";
          };
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "true";
          Unattended-Upgrade::Automatic-Reboot-Time "03:30";
      tags: [hardening]

    - name: Enable unattended upgrades periodic config
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
      tags: [hardening]

    - name: Configure SSH - change port
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port '
        line: "Port {{ ssh_port }}"
        state: present
      tags: [hardening]

    - name: Configure SSH - disable root login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
      tags: [hardening]

    - name: Configure SSH - disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      tags: [hardening]

    - name: Ensure SSH service is enabled and restarted
      ansible.builtin.service:
        name: ssh
        state: restarted
        enabled: true
      tags: [hardening]

    - name: UFW - set default inbound policy
      community.general.ufw:
        policy: deny
        direction: incoming
      tags: [hardening]

    - name: UFW - allow outbound policy
      community.general.ufw:
        direction: outgoing
        policy: allow
      tags: [hardening]

    - name: UFW - allow SSH configured port
      community.general.ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
      tags: [hardening]

    - name: UFW - also allow default SSH (22) to avoid lockout (remove later)
      community.general.ufw:
        rule: allow
        port: "22"
        proto: tcp
      when: ssh_port != 22
      tags: [hardening]

    - name: UFW - allow base TCP ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ base_allowed_tcp_ports }}"
      tags: [hardening]

    - name: UFW - ensure firewall enabled
      community.general.ufw:
        state: enabled
      tags: [hardening]

    - name: Configure Fail2Ban for SSH
      ansible.builtin.copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime  = 1h
          findtime = 10m
          maxretry = 5

          [sshd]
          enabled = true
          port    = {{ ssh_port }}
          filter  = sshd
          logpath = /var/log/auth.log
          backend = systemd
      notify: Restart Fail2Ban
      tags: [hardening]

    - name: Ensure chrony is enabled and started
      ansible.builtin.service:
        name: chrony
        state: started
        enabled: true
      tags: [hardening]

    - name: Create swap file if enabled and no swap present
      ansible.builtin.command: fallocate -l {{ swap_size_gb }}G /swapfile
      args:
        creates: /swapfile
      when: enable_swap and (ansible_swaptotal_mb | int) == 0
      tags: [hardening]

    - name: Set swap file permissions
      ansible.builtin.file:
        path: /swapfile
        owner: root
        group: root
        mode: '0600'
      when: enable_swap and (ansible_swaptotal_mb | int) == 0
      tags: [hardening]

    - name: Make swap
      ansible.builtin.command: mkswap /swapfile
      when: enable_swap and (ansible_swaptotal_mb | int) == 0
      tags: [hardening]

    - name: Enable swap
      ansible.builtin.command: swapon /swapfile
      when: enable_swap and (ansible_swaptotal_mb | int) == 0
      tags: [hardening]

    - name: Persist swap in fstab
      ansible.posix.mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present
      when: enable_swap and (ansible_swaptotal_mb | int) == 0
      tags: [hardening]

    - name: Reduce swappiness
      ansible.posix.sysctl:
        name: vm.swappiness
        value: '10'
        state: present
        reload: true
      when: enable_swap
      tags: [hardening]

    - name: Install CloudPanel (CE)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sSL https://installer.cloudpanel.io/ce/v2/install.sh -o /root/cloudpanel_install.sh
        CLOUDPANEL_DB_ENGINE="{{ cloudpanel_db_engine }}" bash /root/cloudpanel_install.sh
      args:
        creates: /usr/sbin/cloudpanel
        executable: /bin/bash
      tags: [cloudpanel]

    - name: Calculate MariaDB buffer pool target
      ansible.builtin.set_fact:
        maria_buffer_pool_target_mb: "{{ (ansible_memtotal_mb | int * mariadb_buffer_pool_pct // 100) | int }}"
      when: mariadb_tuning
      tags: [cloudpanel, tuning]

    - name: Set calculated MariaDB tuning values
      ansible.builtin.set_fact:
        maria_buffer_pool_mb: "{{ [ (maria_buffer_pool_target_mb | int), 512 ] | max }}"
        maria_buffer_pool_instances: "{{ [ ( [ (maria_buffer_pool_mb | int // 1024), 8 ] | min ), 1 ] | max }}"
        maria_log_file_size_mb: "{{ [ ( [ (maria_buffer_pool_mb | int * 25 // 100), 2048 ] | min ), 256 ] | max }}"
      when: mariadb_tuning
      tags: [cloudpanel, tuning]

    - name: Set calculated Redis maxmemory (MB)
      ansible.builtin.set_fact:
        redis_maxmemory_mb: "{{ [ (ansible_memtotal_mb | int * redis_maxmemory_percent // 100), 256 ] | max }}"
      when: enable_redis
      tags: [cloudpanel, redis]

    - name: Drop MariaDB performance tuning file
      ansible.builtin.template:
        src: templates/mariadb-tuning.cnf.j2
        dest: /etc/mysql/mariadb.conf.d/90-cloudpanel-tuning.cnf
        owner: root
        group: root
        mode: '0644'
      when: mariadb_tuning
      notify: Restart MariaDB
      tags: [cloudpanel, tuning]

    - name: Install Redis server
      ansible.builtin.apt:
        name: redis-server
        state: present
      when: enable_redis
      tags: [cloudpanel, redis]

    - name: Harden Redis configuration
      ansible.builtin.template:
        src: templates/redis.conf.j2
        dest: /etc/redis/redis.conf
        owner: root
        group: root
        mode: '0644'
      when: enable_redis
      notify: Restart Redis
      tags: [cloudpanel, redis]

    - name: Ensure Redis service is enabled
      ansible.builtin.service:
        name: redis-server
        state: started
        enabled: true
      when: enable_redis
      tags: [cloudpanel, redis]

  handlers:
    - name: Restart Fail2Ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted

    - name: Restart MariaDB
      ansible.builtin.service:
        name: mariadb
        state: restarted

    - name: Restart Redis
      ansible.builtin.service:
        name: redis-server
        state: restarted
